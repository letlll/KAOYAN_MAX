zotero.js:332  Service worker (re)started at 2024-09-30 22:44:55 at chrome-extension://nmhdhpibnnopknkmonacoephklnflpho/zotero.js:314
(åŒ¿å) @ zotero.js:332
26Refused to load the font '<URL>' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff2?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.ttf?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.woff2?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.woff?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.ttf?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff2?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.ttf?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.woff2?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.woff?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.ttf?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:11  Refused to load the font 'data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmftt...mCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff2?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.ttf?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.woff2?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.woff?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.ttf?t=1720059496826' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff2?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.woff?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.ttf?t=1719892123421' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.woff2?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.woff?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'https://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.ttf?t=1719910975905' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

index.html:1  Refused to load the font 'data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmftt...mCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC' because it violates the following Content Security Policy directive: "default-src 'self'". Note that 'font-src' was not explicitly set, so 'default-src' is used as a fallback.

8Refused to load the script '<URL>' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

content.tsx-DLLqFVUJ.js:349  Refused to load the script 'http://at.alicdn.com/t/a/font_4553737_3kead1oijus.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'http://at.alicdn.com/t/c/font_4553737_6dp7g1g5esk.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'https://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'http://at.alicdn.com/t/a/font_4553737_jvw2je7cv7.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'https://at.alicdn.com/t/a/font_4383528_nwfgdw1485c.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'http://at.alicdn.com/t/a/font_4515024_vyz4t6ulwdm.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'https://at.alicdn.com/t/a/font_4553737_3kead1oijus.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
content.tsx-DLLqFVUJ.js:349  Refused to load the script 'http://at.alicdn.com/t/a/font_4515024_bpv79tprrkp.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval' 'inline-speculation-rules'". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

createScriptUrlElements @ content.tsx-DLLqFVUJ.js:349
å†æ˜¾ç¤º 1 å¸§
æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
index.html:1  Uncaught (in promise) Object
2script.js:234  Uncaught ReferenceError: card is not defined
    at flipCard (script.js:234:35)
    at HTMLDivElement.handleDrop (script.js:307:17)
script.js:283  Uncaught SyntaxError: Failed to execute 'querySelector' on 'Document': '.card[data-id='è¯·å°†æ‰‘å…‹ç‰Œæ‹–å…¥ B æ¡†
B æ¡†ï¼šæ‹–åŠ¨5å¼ è¿ç»­æ‰‘å…‹ç‰Œåˆ°æ­¤å¤„
']' is not a valid selector.
    at HTMLDivElement.handleDrop (script.js:283:30)
11script.js:234  Uncaught ReferenceError: card is not defined
    at flipCard (script.js:234:35)
    at HTMLDivElement.handleDrop (script.js:307:17)
2script.js:408  Uncaught ReferenceError: countSameSuit is not defined
    at checkStraight (script.js:408:33)
    at HTMLDivElement.handleDrop (script.js:293:13)

---

# ä¸å®Œæ•´ä»£ç 

```
æŠ±æ­‰æ‚¨é‡åˆ°äº†è¿™äº›é—®é¢˜ã€‚æ ¹æ®æ‚¨æä¾›çš„é”™è¯¯ä¿¡æ¯å’Œä»£ç ï¼Œä¸»è¦å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. **JavaScript ä»£ç ä¸­çš„å˜é‡å¼•ç”¨é”™è¯¯**ï¼š
   - åœ¨ `flipCard` å‡½æ•°ä¸­ï¼Œé”™è¯¯åœ°ä½¿ç”¨äº†æœªå®šä¹‰çš„ `card` å˜é‡ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `cardObj`ã€‚
   - åœ¨ `checkStraight` å‡½æ•°ä¸­ï¼Œ`countSameSuit` å‡½æ•°æœªè¢«æ­£ç¡®è¯†åˆ«ï¼Œå¯èƒ½æ˜¯å› ä¸ºä»£ç ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯æˆ–é‡å¤å®šä¹‰ã€‚

2. **Content Security Policy (CSP) é”™è¯¯**ï¼š
   - CSP è®¾ç½®é™åˆ¶äº†ä»å¤–éƒ¨æ¥æºåŠ è½½å­—ä½“å’Œè„šæœ¬ï¼Œå¯¼è‡´æ¥è‡ª `https://at.alicdn.com` çš„èµ„æºæ— æ³•åŠ è½½ã€‚è¿™äº›é”™è¯¯å¤§å¤šä¸æµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚ Zoteroï¼‰ç›¸å…³ï¼Œä¸æ‚¨çš„æ¸¸æˆä»£ç æ— å…³ï¼Œä½†å¦‚æœæ‚¨çš„é¡¹ç›®ç¡®å®éœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬ï¼Œåˆ™éœ€è¦è°ƒæ•´ CSPã€‚

### **1. ä¿®å¤ JavaScript ä»£ç ä¸­çš„é”™è¯¯**

#### **1.1. ç§»é™¤é‡å¤å®šä¹‰çš„å‡½æ•°**

åœ¨æ‚¨çš„ `script.js` ä¸­ï¼Œ`unflipCard` å‡½æ•°è¢«å®šä¹‰äº†ä¸¤æ¬¡ã€‚è¿™ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯ï¼Œé˜»æ­¢åç»­ä»£ç çš„æ‰§è¡Œã€‚è¯·ç§»é™¤å…¶ä¸­ä¸€ä¸ªå®šä¹‰ã€‚

**ç§»é™¤é‡å¤çš„ `unflipCard` å‡½æ•°ï¼š**

```javascript
// ä¿ç•™å…¶ä¸­ä¸€ä¸ª unflipCard å‡½æ•°
function unflipCard(cardDiv) {
    const cardImg = cardDiv.querySelector('img');
    if (cardImg) {
        cardImg.src = 'images/back.jpg'; // æ˜¾ç¤ºèƒŒé¢
        cardDiv.setAttribute('data-flipped', 'false');
    }
    console.log(`Unflipping card: ${cardDiv.getAttribute('data-id')}`);
}
```

#### **1.2. ä¿®æ­£ `flipCard` å‡½æ•°ä¸­çš„å˜é‡å¼•ç”¨**

ç¡®ä¿åœ¨ `flipCard` å‡½æ•°ä¸­ï¼Œæ‰€æœ‰å¯¹ `card` çš„å¼•ç”¨éƒ½å·²æ›´æ­£ä¸º `cardObj`ã€‚

**ä¿®æ­£åçš„ `flipCard` å‡½æ•°ï¼š**

```javascript
// ç¿»è½¬æ‰‘å…‹ç‰Œ
function flipCard(cardDiv) {
    const cardId = cardDiv.getAttribute('data-id');
    const cardObj = getCardObjectById(cardId);

    if (!cardObj) {
        console.error(`Card with ID ${cardId} not found in deck, aDeck, or target.`);
        return;
    }

    const cardImg = cardDiv.querySelector('img');
    if (cardImg) {
        console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`); // ä¿®æ­£æ—¥å¿—
        cardImg.src = cardObj.image; // æ˜¾ç¤ºæ­£é¢
        cardDiv.setAttribute('data-flipped', 'true');
    }
    console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`);
}
```

#### **1.3. ç¡®ä¿ `countSameSuit` å‡½æ•°æ­£ç¡®å®šä¹‰**

åœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œ`countSameSuit` å‡½æ•°å·²ç»å®šä¹‰ï¼Œä½†é”™è¯¯æç¤ºä»ç„¶æ˜¾ç¤ºæœªå®šä¹‰ã€‚è¿™å¯èƒ½æ˜¯ç”±äºå‰é¢çš„è¯­æ³•é”™è¯¯ï¼ˆå¦‚é‡å¤å®šä¹‰å‡½æ•°ï¼‰å¯¼è‡´å‡½æ•°æœªèƒ½æ­£ç¡®åŠ è½½ã€‚

**ç¡®ä¿ `countSameSuit` å‡½æ•°æ­£ç¡®å®šä¹‰ï¼š**

```javascript
// è®¡ç®—ç›®æ ‡åŒºåŸŸä¸­åŒèŠ±è‰²çš„æœ€å¤§æ•°é‡
function countSameSuit(cards) {
    const suitCounts = {};
    cards.forEach(card => {
        suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;
    });
    return Math.max(...Object.values(suitCounts));
}
```

#### **1.4. ä¿®æ”¹ `handleDrop` å‡½æ•°ä»¥å¤„ç†æ— æ•ˆçš„ `cardId`**

ç”±äºæ‹–åŠ¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ„å¤–æ‹–åŠ¨éå¡ç‰Œå…ƒç´ ï¼Œå¯¼è‡´ `cardId` ä¸æ­£ç¡®ã€‚éœ€è¦åœ¨ `handleDrop` å‡½æ•°ä¸­æ·»åŠ éªŒè¯ï¼Œç¡®ä¿ `cardId` æ˜¯æœ‰æ•ˆçš„å¡ç‰Œ IDã€‚

**ä¿®æ­£åçš„ `handleDrop` å‡½æ•°ï¼š**

```javascript
// å¤„ç†æ”¾ç½®äº‹ä»¶
function handleDrop(e) {
    e.preventDefault();
    const cardId = e.dataTransfer.getData('text/plain');
    
    // éªŒè¯ cardId æ˜¯å¦ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œä¾‹å¦‚ 'card-spade-A'
    const validCardIdPattern = /^card-(spade|heart|clover|diamond)-(A|[2-9]|10|J|Q|K)$/;
    if (!validCardIdPattern.test(cardId)) {
        console.error(`Invalid cardId: ${cardId}`);
        showMessage('æ— æ•ˆçš„å¡ç‰‡è¢«æ‹–åŠ¨ï¼', 'fail');
        return;
    }

    const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);
    if (!cardDiv) {
        console.error(`No card found with id ${cardId}`);
        showMessage('æœªæ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡ï¼', 'fail');
        return;
    }

    const source = cardDiv.parentElement.id;

    if (this.id === 'target') {
        if (source === 'target') {
            // åœ¨ B æ¡†å†…é‡æ–°æ’åˆ—æ‰‘å…‹ç‰Œ
            targetElement.appendChild(cardDiv);
            // ä¸ä¿®æ”¹ target æ•°ç»„ï¼Œä¹Ÿä¸å¢åŠ  dragCount
            checkStraight();
            saveGameState();
        } else {
            // ä» A æ¡†æ‹–åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†
            if (target.length >= 5) {
                // B æ¡†å·²æ»¡
                showMessage('B æ¡†å·²æ»¡ï¼', 'fail');
                return;
            }
            // ç§»åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†
            targetElement.appendChild(cardDiv);
            const cardObj = getCardObjectById(cardId);
            if (cardObj && !target.some(card => card.id === cardId)) {
                target.push(cardObj);
                flipCard(cardDiv); // è‡ªåŠ¨ç¿»è½¬æ‰‘å…‹ç‰Œ
                dragCount++;
                updateDragCount();
                aFrameTooltip.style.display = 'none';
                checkStraight();
                saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€
                // ä» aDeck ä¸­ç§»é™¤å·²è¢«æ‹–å…¥ B æ¡†çš„æ‰‘å…‹ç‰Œ
                aDeck = aDeck.filter(card => card.id !== cardId);
            }
        }
    } else if (this.id === 'deck') {
        if (source === 'target') {
            // ä» B æ¡†æ‹–å› A æ¡†
            deckElement.appendChild(cardDiv);
            target = target.filter(card => card.id !== cardId);
            const cardObj = getCardObjectById(cardId);
            if (cardObj) {
                aDeck.push(cardObj); // å°†æ‰‘å…‹ç‰Œæ·»åŠ å› aDeck
                unflipCard(cardDiv); // è‡ªåŠ¨å›åˆ°èƒŒé¢
                dragCount++;
                updateDragCount();
                if (target.length < 5) {
                    aFrameTooltip.style.display = 'block';
                }
                saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€
            }
        }
    }
    console.log(`Dragging card: ${cardId} from ${source} to ${this.id}`);
    console.log('Target Deck:', target.map(card => card.id));
    console.log('A Deck:', aDeck.map(card => card.id));
}
```

#### **1.5. ä¿®æ”¹ `loadGameState` å‡½æ•°ä»¥æ­£ç¡®æ˜¾ç¤ºå¾—åˆ†å’Œè®¡æ—¶å™¨**

åœ¨ `loadGameState` å‡½æ•°ä¸­ï¼Œè°ƒç”¨ `updateScore(0)` ä¼šå°†å¾—åˆ†å¢åŠ  0ï¼Œä½†æ²¡æœ‰ç›´æ¥è®¾ç½®å¾—åˆ†æ˜¾ç¤ºã€‚å»ºè®®ç›´æ¥æ›´æ–°å¾—åˆ†æ˜¾ç¤ºã€‚

**ä¿®æ­£åçš„ `loadGameState` å‡½æ•°ï¼š**

```javascript
// åŠ è½½æ¸¸æˆçŠ¶æ€
function loadGameState() {
    const savedState = localStorage.getItem('gameState');
    if (savedState) {
        const gameState = JSON.parse(savedState);
        dragCount = gameState.dragCount;
        score = gameState.score || 0;
        comboCount = gameState.comboCount || 0;
        timeLeft = gameState.timeLeft || 60;
        updateDragCount();
        updateScore(0); // è¿™é‡Œå¯ä»¥æ”¹ä¸ºç›´æ¥è®¾ç½®æ˜¾ç¤º
        scoreElement.textContent = `å¾—åˆ†ï¼š${score}`; // ç›´æ¥æ›´æ–°æ˜¾ç¤º
        timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;

        // æ¢å¤ç›®æ ‡åŒºåŸŸ
        gameState.target.forEach(cardId => {
            const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);
            if (cardDiv) {
                targetElement.appendChild(cardDiv);
                const cardObj = getCardObjectById(cardId);
                if (cardObj) {
                    target.push(cardObj);
                    flipCard(cardDiv);
                }
            }
        });

        // æ¢å¤è®¡æ—¶å™¨
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                showMessage('æ—¶é—´åˆ°ï¼æ¸¸æˆå¤±è´¥ã€‚', 'fail');
                endgameModal.classList.remove('hidden');
                finalCountElement.textContent = `ä½ çš„æ‹–åŠ¨æ¬¡æ•°æ˜¯ ${dragCount} æ¬¡ï¼Œæ€»å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;
            }
        }, 1000);
    }
}
```

### **2. å¤„ç† Content Security Policy (CSP) é”™è¯¯**

CSP é”™è¯¯é€šå¸¸ç”±ä»¥ä¸‹åŸå› å¼•èµ·ï¼š

- **æµè§ˆå™¨æ‰©å±•**ï¼šå¦‚ Zoteroï¼Œå¯èƒ½ä¼šæ³¨å…¥è„šæœ¬å’Œå­—ä½“ï¼Œå¯¼è‡´ CSP é”™è¯¯ã€‚è¿™äº›é”™è¯¯é€šå¸¸ä¸ä¼šå½±å“æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä½†ä¼šåœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºã€‚
- **å¤–éƒ¨èµ„æº**ï¼šå¦‚æœæ‚¨çš„é¡¹ç›®ç¡®å®éœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬ï¼Œå¿…é¡»åœ¨ CSP ä¸­æ˜ç¡®å…è®¸è¿™äº›æ¥æºã€‚

#### **2.1. å¦‚æœ CSP é”™è¯¯æ¥è‡ªæµè§ˆå™¨æ‰©å±•**

è¿™äº›é”™è¯¯å¯ä»¥å¿½ç•¥ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šå½±å“æ‚¨çš„åº”ç”¨ç¨‹åºã€‚ä½†ä¸ºäº†é¿å…å¹²æ‰°ï¼Œè¯·ç¡®ä¿æ‚¨çš„ä»£ç æ²¡æœ‰ä¾èµ–è¿™äº›å¤–éƒ¨èµ„æºã€‚

#### **2.2. å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬**

æ‚¨éœ€è¦åœ¨ CSP ä¸­æ˜ç¡®å…è®¸è¿™äº›èµ„æºã€‚ä¿®æ”¹æ‚¨çš„ `index.html` ä¸­çš„ `<meta http-equiv="Content-Security-Policy">` æ ‡ç­¾ï¼Œæ·»åŠ å¿…è¦çš„æºã€‚

**ç¤ºä¾‹ CSP ä¿®æ”¹ï¼š**

```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self'; 
    script-src 'self' 'unsafe-inline' https://at.alicdn.com; 
    style-src 'self' 'unsafe-inline' https://at.alicdn.com; 
    font-src 'self' https://at.alicdn.com;
">
```

**è§£é‡Šï¼š**

- `script-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„è„šæœ¬ã€‚
- `style-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„æ ·å¼ã€‚
- `font-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„å­—ä½“ã€‚

**æ³¨æ„**ï¼šä»…åœ¨ç¡®å®éœ€è¦æ—¶æ·»åŠ å¤–éƒ¨æºï¼Œå¹¶ç¡®ä¿åªå…è®¸å¯ä¿¡çš„æ¥æºï¼Œä»¥ä¿æŒå®‰å…¨æ€§ã€‚

### **3. å®Œæ•´ä¿®æ­£åçš„ `script.js`**

ä»¥ä¸‹æ˜¯ä¿®æ­£åçš„å®Œæ•´ `script.js`ï¼ŒåŒ…æ‹¬æ‰€æœ‰ä¸Šè¿°ä¿®å¤å’Œä¼˜åŒ–ï¼š

```javascript
// script.js

// è·å–DOMå…ƒç´ 
const deckElement = document.getElementById('deck');
const targetElement = document.getElementById('target');
const dragCountElement = document.getElementById('drag-count');
const resetButton = document.getElementById('reset-button');
const endgameModal = document.getElementById('endgame-modal');
const finalCountElement = document.getElementById('final-count');
const messageBox = document.getElementById('message-box');
const replayButton = document.getElementById('replay-button');
const soundToggle = document.getElementById('sound-toggle');
const successSound = document.getElementById('success-sound');
const failSound = document.getElementById('fail-sound');
const aFrameTooltip = document.getElementById('a-frame-tooltip');
const scoreElement = document.getElementById('score');
const timerElement = document.getElementById('timer');

// æ¸¸æˆçŠ¶æ€
let deck = [];
let aDeck = [];
let target = [];
let dragCount = 0;
let score = 0;
let comboCount = 0;
let isSoundOn = true;
let timer;
let timeLeft = 60;

// æ‰‘å…‹ç‰Œæ•°æ®
const suits = ['spade', 'heart', 'clover', 'diamond'];
const numbers = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

function initGame() {
    // é‡ç½®çŠ¶æ€
    deck = [];
    aDeck = [];
    target = [];
    dragCount = 0;
    score = 0;
    comboCount = 0;
    updateDragCount();
    updateScore(0);
    deckElement.innerHTML = '';
    targetElement.innerHTML = '';
    aFrameTooltip.style.display = 'block';
    messageBox.classList.add('hidden', 'success', 'fail', 'info');
    endgameModal.classList.add('hidden');

    // ç”Ÿæˆä¸€å‰¯å®Œæ•´çš„æ‰‘å…‹ç‰Œï¼ˆåŒ…å«æ‰€æœ‰èŠ±è‰²ï¼‰
    for (let suit of suits) {
        for (let number of numbers) {
            deck.push({
                id: `card-${suit}-${number}`,
                number: number,
                suit: suit,
                image: `images/${suit}_${number}.jpg` // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
            });
        }
    }

    // æ‰“ä¹±é¡ºåº
    deck = shuffleArray(deck);

    // ç¡®ä¿åŒ…å«ä¸€ä¸ªé¡ºå­ç»„åˆ
    const possibleSequences = [
        [1, 2, 3, 4, 5],
        [2, 3, 4, 5, 6],
        [3, 4, 5, 6, 7],
        [4, 5, 6, 7, 8],
        [5, 6, 7, 8, 9],
        [6, 7, 8, 9, 10],
        [7, 8, 9, 10, 11],
        [8, 9, 10, 11, 12],
        [9, 10, 11, 12, 13],
        [10, 11, 12, 13, 1] // Ace as 14
    ];

    // éšæœºé€‰æ‹©ä¸€ä¸ªé¡ºå­ç»„åˆ
    const chosenSequence = possibleSequences[Math.floor(Math.random() * possibleSequences.length)];

    // å°†é¡ºå­åŠ å…¥ A æ¡†ï¼Œä½¿ç”¨ä¸åŒçš„èŠ±è‰²
    chosenSequence.forEach((num, index) => {
        const suit = suits[index % suits.length];
        const foundCard = deck.find(card => card.number == num && card.suit === suit);
        if (foundCard) {
            aDeck.push(foundCard);
        } else {
            console.error(`æ— æ³•æ‰¾åˆ°æ•°å­— ${num} å’ŒèŠ±è‰² ${suit} çš„æ‰‘å…‹ç‰Œã€‚`);
        }
    });

    // ä»å‰©ä½™ç‰Œä¸­éšæœºè¡¥è¶³è‡³13å¼ 
    deck = deck.filter(card => !aDeck.includes(card));
    while (aDeck.length < 13 && deck.length > 0) {
        const randomIndex = Math.floor(Math.random() * deck.length);
        const randomCard = deck.splice(randomIndex, 1)[0];
        if (randomCard) {
            aDeck.push(randomCard);
        }
    }

    // æ‰“ä¹±Aæ¡†çš„é¡ºåº
    aDeck = shuffleArray(aDeck);

    // æ£€æŸ¥ aDeck æ˜¯å¦æœ‰13å¼ ç‰Œ
    if (aDeck.length < 13) {
        console.error(`A æ¡†çš„ç‰Œæ•°ä¸è¶³ï¼Œå½“å‰æœ‰ ${aDeck.length} å¼ ç‰Œã€‚`);
        // å¯é€‰æ‹©è¡¥å……å…¶ä»–ç‰Œæˆ–é‡æ–°ç”Ÿæˆ aDeck
    }

    // å°† A æ¡†ä¸­çš„æ‰‘å…‹ç‰Œå…ƒç´ æ·»åŠ åˆ°ç•Œé¢ä¸­
    aDeck.forEach(card => {
        const cardElement = createCardElement(card);
        deckElement.appendChild(cardElement);
    });

    // é¢„åŠ è½½å›¾ç‰‡
    preloadImages();

    // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
    clearGameState();

    // ä¸åŠ è½½æ¸¸æˆçŠ¶æ€ï¼Œé¿å…é‡ç½®æ—¶åŠ è½½æ—§çš„æ¸¸æˆçŠ¶æ€
    // loadGameState(); // æ³¨é‡Šæ‰è¿™è¡Œï¼Œé¿å…å¹²æ‰°åˆå§‹åŒ–

    // å¯åŠ¨è®¡æ—¶å™¨
    startTimer();

    console.log('åˆå§‹åŒ–æ¸¸æˆå®Œæˆã€‚A Deck:', aDeck.map(c => c.id));
    console.log('A Deck:', aDeck.map(card => card.id));
    console.log('Remaining Deck:', deck.map(card => card.id));
}

// æ›´æ–°å¾—åˆ†æ˜¾ç¤º
function updateScore(points) {
    score += points;
    scoreElement.textContent = `å¾—åˆ†ï¼š${score}`;
}

// æ›´æ–°æ‹–åŠ¨æ¬¡æ•°æ˜¾ç¤º
function updateDragCount() {
    dragCountElement.textContent = `æ‹–åŠ¨æ¬¡æ•°ï¼š${dragCount}`;
}

// æ´—ç‰Œç®—æ³•ï¼ˆFisher-Yatesï¼‰
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;

    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // äº¤æ¢
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }

    return array;
}

// é¢„åŠ è½½å›¾ç‰‡
function preloadImages() {
    const imageUrls = deck.map(card => card.image);
    imageUrls.push('images/back.jpg');
    imageUrls.forEach(url => {
        const img = new Image();
        img.src = url;
    });
}

// åˆ›å»ºæ‰‘å…‹ç‰Œå…ƒç´ 
function createCardElement(card) {
    const cardDiv = document.createElement('div');
    cardDiv.classList.add('card');
    cardDiv.setAttribute('draggable', true);
    cardDiv.setAttribute('data-id', card.id);
    cardDiv.setAttribute('data-number', card.number);
    cardDiv.setAttribute('data-suit', card.suit);
    cardDiv.setAttribute('data-flipped', 'false');

    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
    const cardImg = document.createElement('img');
    cardImg.src = 'images/back.jpg'; // åˆå§‹æ˜¾ç¤ºèƒŒé¢
    cardImg.alt = `${card.suit} ${card.number}`;
    cardImg.classList.add('card-image');

    console.log(`Creating card: ${card.id} with image ${cardImg.src}`); // è°ƒè¯•æ—¥å¿—

    cardDiv.appendChild(cardImg);

    // äº‹ä»¶ç›‘å¬
    cardDiv.addEventListener('dragstart', handleDragStart);
    // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    // cardDiv.addEventListener('click', handleCardClick);
    cardDiv.addEventListener('dragend', handleDragEnd);

    return cardDiv;
}

// ç¿»è½¬æ‰‘å…‹ç‰Œ
function flipCard(cardDiv) {
    const cardId = cardDiv.getAttribute('data-id');
    const cardObj = getCardObjectById(cardId);

    if (!cardObj) {
        console.error(`Card with ID ${cardId} not found in deck, aDeck, or target.`);
        return;
    }

    const cardImg = cardDiv.querySelector('img');
    if (cardImg) {
        console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`); // ä¿®æ­£æ—¥å¿—
        cardImg.src = cardObj.image; // æ˜¾ç¤ºæ­£é¢
        cardDiv.setAttribute('data-flipped', 'true');
    }
    console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`);
}

// åè½¬æ‰‘å…‹ç‰Œå›èƒŒé¢
function unflipCard(cardDiv) {
    const cardImg = cardDiv.querySelector('img');
    if (cardImg) {
        cardImg.src = 'images/back.jpg'; // æ˜¾ç¤ºèƒŒé¢
        cardDiv.setAttribute('data-flipped', 'false');
    }
    console.log(`Unflipping card: ${cardDiv.getAttribute('data-id')}`);
}

// å¤„ç†æ‹–åŠ¨å¼€å§‹
function handleDragStart(e) {
    const cardDiv = e.currentTarget;
    e.dataTransfer.setData('text/plain', cardDiv.getAttribute('data-id'));
    setTimeout(() => {
        cardDiv.classList.add('dragging');
    }, 0);
}

// å¤„ç†æ‹–åŠ¨ç»“æŸ
function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
}

// å…è®¸æ‹–æ”¾åŒºåŸŸ
function allowDrop(e) {
    e.preventDefault();
}

// å¤„ç†æ”¾ç½®äº‹ä»¶
function handleDrop(e) {
    e.preventDefault();
    const cardId = e.dataTransfer.getData('text/plain');

    // éªŒè¯ cardId æ˜¯å¦ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œä¾‹å¦‚ 'card-spade-A'
    const validCardIdPattern = /^card-(spade|heart|clover|diamond)-(A|[2-9]|10|J|Q|K)$/;
    if (!validCardIdPattern.test(cardId)) {
        console.error(`Invalid cardId: ${cardId}`);
        showMessage('æ— æ•ˆçš„å¡ç‰‡è¢«æ‹–åŠ¨ï¼', 'fail');
        return;
    }

    const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);
    if (!cardDiv) {
        console.error(`No card found with id ${cardId}`);
        showMessage('æœªæ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡ï¼', 'fail');
        return;
    }

    const source = cardDiv.parentElement.id;

    if (this.id === 'target') {
        if (source === 'target') {
            // åœ¨ B æ¡†å†…é‡æ–°æ’åˆ—æ‰‘å…‹ç‰Œ
            targetElement.appendChild(cardDiv);
            // ä¸ä¿®æ”¹ target æ•°ç»„ï¼Œä¹Ÿä¸å¢åŠ  dragCount
            checkStraight();
            saveGameState();
        } else {
            // ä» A æ¡†æ‹–åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†
            if (target.length >= 5) {
                // B æ¡†å·²æ»¡
                showMessage('B æ¡†å·²æ»¡ï¼', 'fail');
                return;
            }
            // ç§»åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†
            targetElement.appendChild(cardDiv);
            const cardObj = getCardObjectById(cardId);
            if (cardObj && !target.some(card => card.id === cardId)) {
                target.push(cardObj);
                flipCard(cardDiv); // è‡ªåŠ¨ç¿»è½¬æ‰‘å…‹ç‰Œ
                dragCount++;
                updateDragCount();
                aFrameTooltip.style.display = 'none';
                checkStraight();
                saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€
                // ä» aDeck ä¸­ç§»é™¤å·²è¢«æ‹–å…¥ B æ¡†çš„æ‰‘å…‹ç‰Œ
                aDeck = aDeck.filter(card => card.id !== cardId);
            }
        }
    } else if (this.id === 'deck') {
        if (source === 'target') {
            // ä» B æ¡†æ‹–å› A æ¡†
            deckElement.appendChild(cardDiv);
            target = target.filter(card => card.id !== cardId);
            const cardObj = getCardObjectById(cardId);
            if (cardObj) {
                aDeck.push(cardObj); // å°†æ‰‘å…‹ç‰Œæ·»åŠ å› aDeck
                unflipCard(cardDiv); // è‡ªåŠ¨å›åˆ°èƒŒé¢
                dragCount++;
                updateDragCount();
                if (target.length < 5) {
                    aFrameTooltip.style.display = 'block';
                }
                saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€
            }
        }
    }
    console.log(`Dragging card: ${cardId} from ${source} to ${this.id}`);
    console.log('Target Deck:', target.map(card => card.id));
    console.log('A Deck:', aDeck.map(card => card.id));
}

// è·å–å¡ç‰‡å¯¹è±¡é€šè¿‡ID
function getCardObjectById(cardId) {
    return deck.find(c => c.id === cardId) || aDeck.find(c => c.id === cardId) || target.find(c => c.id === cardId) || null;
}

// æ˜¾ç¤ºæ¶ˆæ¯æç¤º
function showMessage(message, type) {
    messageBox.textContent = message;
    messageBox.classList.remove('hidden', 'success', 'fail', 'info');
    if (type === 'success') {
        messageBox.classList.add('success');
        if (isSoundOn) successSound.play();
    } else if (type === 'fail') {
        messageBox.classList.add('fail');
        if (isSoundOn) failSound.play();
    } else if (type === 'info') {
        messageBox.classList.add('info');
    }
    messageBox.classList.add('visible');
    setTimeout(() => {
        messageBox.classList.remove('visible');
    }, 5000);
}

// è®¡ç®—ç›®æ ‡åŒºåŸŸä¸­åŒèŠ±è‰²çš„æœ€å¤§æ•°é‡
function countSameSuit(cards) {
    const suitCounts = {};
    cards.forEach(card => {
        suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;
    });
    return Math.max(...Object.values(suitCounts));
}

function checkStraight() {
    if (target.length === 5) {
        // è·å–ç‰Œçš„æ•°å­—å€¼
        let numberValues = target.map(card => getNumberValue(card.number));

        // è€ƒè™‘ Ace çš„åŒé‡æ€§ï¼ˆ1 æˆ– 14ï¼‰
        const hasAce = numberValues.includes(1);
        let possibleStraightSets = [];

        if (hasAce) {
            const aceAs14 = numberValues.map(val => val === 1 ? 14 : val);
            possibleStraightSets.push(aceAs14);
        }

        possibleStraightSets.push(numberValues);

        // æ£€æŸ¥æ˜¯å¦ä¸ºé¡ºå­
        const isStraight = possibleStraightSets.some(values => {
            const sorted = [...values].sort((a, b) => a - b);
            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] !== sorted[i - 1] + 1) {
                    return false;
                }
            }
            return true;
        });

        if (isStraight) {
            clearInterval(timer);
            comboCount++;
            let baseScore = 100;
            let sameSuitCount = countSameSuit(target);
            let suitBonus = sameSuitCount * 10;
            let comboBonus = comboCount > 1 ? (comboCount - 1) * 20 : 0;
            let totalPoints = baseScore + suitBonus + comboBonus;

            updateScore(totalPoints);

            showMessage(`âœ” é¡ºå­å®Œæˆï¼å¾—åˆ†ï¼š${totalPoints}ï¼ è¿å‡»ï¼š${comboCount}`, 'success');
            finalCountElement.textContent = `ä½ çš„æ‹–åŠ¨æ¬¡æ•°æ˜¯ ${dragCount} æ¬¡ï¼Œæ€»å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;
            endgameModal.classList.remove('hidden');
            saveGameState();
        } else {
            comboCount = 0;
            showMessage('âš  é¡ºå­æœªå®Œæˆï¼Œè¯·è°ƒæ•´æ‰‘å…‹ç‰Œé¡ºåºã€‚', 'fail');
        }
    }
}

// è·å–æ•°å­—å¯¹åº”çš„å€¼
function getNumberValue(number) {
    switch (number) {
        case 'A': return 1;
        case 'J': return 11;
        case 'Q': return 12;
        case 'K': return 13;
        case 'Joker': return 0; // å¦‚æœæœ‰ Jokerï¼Œå¯ä»¥èµ‹äºˆç‰¹æ®Šå€¼
        default: return parseInt(number);
    }
}

function startTimer() {
    timeLeft = 60;
    timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;
    timer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            showMessage('æ—¶é—´åˆ°ï¼æ¸¸æˆå¤±è´¥ã€‚', 'fail');
            endgameModal.classList.remove('hidden');
            finalCountElement.textContent = `ä½ çš„æ‹–åŠ¨æ¬¡æ•°æ˜¯ ${dragCount} æ¬¡ï¼Œæ€»å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;
        }
    }, 1000);
}

function resetTimer() {
    clearInterval(timer);
    startTimer();
}

// é‡ç½®æ¸¸æˆ
resetButton.addEventListener('click', () => {
    clearGameState(); // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
    initGame(); // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
});

// é‡ç©æŒ‰é’®
replayButton.addEventListener('click', () => {
    endgameModal.classList.add('hidden');
    clearGameState();
    initGame();
});

// éŸ³æ•ˆå¼€å…³
soundToggle.addEventListener('click', () => {
    isSoundOn = !isSoundOn;
    soundToggle.textContent = isSoundOn ? 'ğŸ”Š' : 'ğŸ”‡';
});

// æ‹–æ”¾äº‹ä»¶ç»‘å®š
deckElement.addEventListener('dragover', allowDrop);
deckElement.addEventListener('drop', handleDrop);
targetElement.addEventListener('dragover', allowDrop);
targetElement.addEventListener('drop', handleDrop);

// åˆå§‹åŒ–æ¸¸æˆ
initGame();

// å¤„ç†æ‹–åŠ¨ç»“æŸç§»é™¤æ ·å¼
document.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('card')) {
        e.target.classList.remove('dragging');
    }
});

// æœ¬åœ°å­˜å‚¨åŠŸèƒ½

// ä¿å­˜æ¸¸æˆçŠ¶æ€
function saveGameState() {
    const gameState = {
        dragCount: dragCount,
        target: target.map(card => card.id),
        score: score,
        comboCount: comboCount,
        timeLeft: timeLeft
    };
    localStorage.setItem('gameState', JSON.stringify(gameState));
}

// åŠ è½½æ¸¸æˆçŠ¶æ€
function loadGameState() {
    const savedState = localStorage.getItem('gameState');
    if (savedState) {
        const gameState = JSON.parse(savedState);
        dragCount = gameState.dragCount;
        score = gameState.score || 0;
        comboCount = gameState.comboCount || 0;
        timeLeft = gameState.timeLeft || 60;
        updateDragCount();
        updateScore(0); // ä¿®æ”¹ä¸ºç›´æ¥è®¾ç½®æ˜¾ç¤º
        scoreElement.textContent = `å¾—åˆ†ï¼š${score}`;
        timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;

        // æ¢å¤ç›®æ ‡åŒºåŸŸ
        gameState.target.forEach(cardId => {
            const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);
            if (cardDiv) {
                targetElement.appendChild(cardDiv);
                const cardObj = getCardObjectById(cardId);
                if (cardObj) {
                    target.push(cardObj);
                    flipCard(cardDiv);
                }
            }
        });

        // æ¢å¤è®¡æ—¶å™¨
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                showMessage('æ—¶é—´åˆ°ï¼æ¸¸æˆå¤±è´¥ã€‚', 'fail');
                endgameModal.classList.remove('hidden');
                finalCountElement.textContent = `ä½ çš„æ‹–åŠ¨æ¬¡æ•°æ˜¯ ${dragCount} æ¬¡ï¼Œæ€»å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;
            }
        }, 1000);
    }
}

// æ¸…é™¤æ¸¸æˆçŠ¶æ€
function clearGameState() {
    localStorage.removeItem('gameState');
}
```

### **4. éªŒè¯å’Œæµ‹è¯•**

å®Œæˆä¸Šè¿°ä¿®å¤åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤éªŒè¯å’Œæµ‹è¯•æ‚¨çš„åº”ç”¨ï¼š

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼š
   - æœ‰æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šç¼“å­˜æ—§çš„ JavaScript æ–‡ä»¶ã€‚ç¡®ä¿æ¸…é™¤ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•/éšç§æ¨¡å¼é‡æ–°åŠ è½½é¡µé¢ã€‚

2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼š
   - æŒ‰ `F12` æˆ–å³é”®ç‚¹å‡»é¡µé¢é€‰æ‹©â€œæ£€æŸ¥â€å¹¶åˆ‡æ¢åˆ°â€œæ§åˆ¶å°â€æ ‡ç­¾ï¼ŒæŸ¥çœ‹æ˜¯å¦è¿˜æœ‰é”™è¯¯ã€‚

3. **å¯åŠ¨æ¸¸æˆå¹¶è¿›è¡Œæ“ä½œ**ï¼š
   - ç¡®ä¿æ¸¸æˆåˆå§‹åŒ–æ—¶ï¼Œå¡ç‰Œæ­£ç¡®ç”Ÿæˆï¼Œè®¡æ—¶å™¨å¼€å§‹å€’è®¡æ—¶ã€‚
   - å°è¯•æ‹–åŠ¨å¡ç‰Œåˆ° B æ¡†ï¼Œå®Œæˆé¡ºå­ï¼Œè§‚å¯Ÿæ˜¯å¦æ­£ç¡®è¯†åˆ«å¹¶æ›´æ–°å¾—åˆ†ã€‚
   - éªŒè¯æ¸¸æˆç»“æŸå¼¹çª—æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºï¼Œå¹¶æ˜¾ç¤ºæ­£ç¡®çš„æ‹–åŠ¨æ¬¡æ•°å’Œå¾—åˆ†ã€‚

4. **æ£€æŸ¥å¾—åˆ†å’Œè®¡æ—¶å™¨**ï¼š
   - ç¡®ä¿åœ¨å®Œæˆé¡ºå­æ—¶ï¼Œå¾—åˆ†æ­£ç¡®å¢åŠ ï¼Œå¹¶ä¸”è®¡æ—¶å™¨åœæ­¢ã€‚
   - åœ¨è®¡æ—¶å™¨å½’é›¶æ—¶ï¼Œç¡®ä¿æ¸¸æˆç»“æŸå¹¶æ˜¾ç¤ºç›¸åº”æ¶ˆæ¯ã€‚

### **5. è¿›ä¸€æ­¥ä¼˜åŒ–**

#### **5.1. é˜²æ­¢æ‹–åŠ¨éå¡ç‰Œå…ƒç´ **

è™½ç„¶é€šè¿‡éªŒè¯ `cardId` å¯ä»¥é˜²æ­¢æ— æ•ˆæ‹–åŠ¨ï¼Œä½†æ‚¨è¿˜å¯ä»¥è¿›ä¸€æ­¥ç¡®ä¿åªæœ‰å¡ç‰Œå…ƒç´ å¯ä»¥è¢«æ‹–åŠ¨ã€‚

**ç¡®ä¿åªæœ‰å¡ç‰Œå…ƒç´ å…·æœ‰ `draggable` å±æ€§ï¼š**

åœ¨ HTML å’Œ CSS ä¸­ï¼Œç¡®ä¿åªæœ‰ `.card` å…ƒç´ å¯ä»¥è¢«æ‹–åŠ¨ï¼Œä¸ä¼šæœ‰å…¶ä»–å…ƒç´ å“åº”æ‹–åŠ¨äº‹ä»¶ã€‚

#### **5.2. æé«˜ç”¨æˆ·ä½“éªŒ**

- **æ·»åŠ åŠ¨ç”»æ•ˆæœ**ï¼šåœ¨æˆåŠŸå®Œæˆé¡ºå­æˆ–å¤±è´¥æ—¶ï¼Œæ·»åŠ è§†è§‰åŠ¨ç”»ï¼Œå¦‚é—ªå…‰æˆ–å¼¹å‡ºåŠ¨ç”»ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
- **æç¤ºåŠŸèƒ½**ï¼šå¦‚æœç”¨æˆ·åœ¨æ‹–åŠ¨è¿‡ç¨‹ä¸­é‡åˆ°å›°éš¾ï¼Œå¯ä»¥æ·»åŠ æç¤ºæŒ‰é’®ï¼Œå¸®åŠ©ç”¨æˆ·æ‰¾åˆ°é¡ºå­çš„æ’åˆ—æ–¹å¼ã€‚
- **æ’è¡Œæ¦œå’Œæˆå°±ç³»ç»Ÿ**ï¼šå¦‚å‰è¿°å»ºè®®ï¼Œå¢åŠ æ’è¡Œæ¦œå’Œæˆå°±ç³»ç»Ÿï¼Œè¿›ä¸€æ­¥æå‡æ¸¸æˆçš„è¶£å‘³æ€§å’ŒæŒ‘æˆ˜æ€§ã€‚

### **6. å¤„ç† Content Security Policy (CSP) é”™è¯¯**

å¦‚å‰æ‰€è¿°ï¼ŒCSP é”™è¯¯ä¸»è¦æ˜¯ç”±äºåŠ è½½å¤–éƒ¨å­—ä½“å’Œè„šæœ¬è¢«é˜»æ­¢ã€‚æ ¹æ®æ‚¨çš„éœ€æ±‚å†³å®šæ˜¯å¦éœ€è¦è¿™äº›å¤–éƒ¨èµ„æºï¼š

- **å¦‚æœä¸éœ€è¦**ï¼šæ£€æŸ¥æ‚¨çš„ CSS æ˜¯å¦å¼•ç”¨äº† `https://at.alicdn.com` çš„å­—ä½“æˆ–è„šæœ¬ã€‚å¦‚æœä¸éœ€è¦ï¼Œç§»é™¤è¿™äº›å¼•ç”¨ã€‚
  
- **å¦‚æœéœ€è¦**ï¼šæ›´æ–° CSP ä»¥å…è®¸è¿™äº›å¤–éƒ¨æ¥æºã€‚

**ç¤ºä¾‹ CSS ç§»é™¤å¤–éƒ¨å­—ä½“å¼•ç”¨ï¼š**

æ£€æŸ¥ `styles.css` æ˜¯å¦æœ‰å¦‚ä¸‹å¼•ç”¨ï¼Œè‹¥ä¸éœ€è¦ï¼Œè¯·ç§»é™¤ï¼š

```css
@font-face {
    font-family: 'SomeFont';
    src: url('https://at.alicdn.com/t/a/font_4553737_3kead1oijus.woff2') format('woff2');
}
```

**æˆ–æ›´æ–° CSP å…è®¸ç‰¹å®šå¤–éƒ¨èµ„æºï¼š**

```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self'; 
    script-src 'self' 'unsafe-inline' https://at.alicdn.com; 
    style-src 'self' 'unsafe-inline' https://at.alicdn.com; 
    font-src 'self' https://at.alicdn.com;
">
```

**æ³¨æ„**ï¼šä»…å…è®¸å¯ä¿¡çš„æ¥æºï¼Œé¿å…å®‰å…¨é£é™©ã€‚

### **7. æ€»ç»“**

é€šè¿‡ä»¥ä¸‹æ­¥éª¤ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè§£å†³å½“å‰é‡åˆ°çš„é—®é¢˜ï¼š

1. **ä¿®å¤ JavaScript ä»£ç ä¸­çš„å˜é‡å¼•ç”¨é”™è¯¯**ï¼Œç¡®ä¿æ‰€æœ‰ `card` å¼•ç”¨éƒ½å·²æ›´æ­£ä¸º `cardObj`ã€‚
2. **ç§»é™¤é‡å¤å®šä¹‰çš„å‡½æ•°**ï¼Œå¦‚ `unflipCard`ï¼Œé¿å…è¯­æ³•é”™è¯¯é˜»æ­¢ä»£ç æ‰§è¡Œã€‚
3. **ç¡®ä¿æ‰€æœ‰è¾…åŠ©å‡½æ•°**ï¼ˆå¦‚ `countSameSuit`ï¼‰æ­£ç¡®å®šä¹‰å¹¶åœ¨éœ€è¦æ—¶å¯ç”¨ã€‚
4. **åœ¨ `handleDrop` å‡½æ•°ä¸­æ·»åŠ éªŒè¯**ï¼Œé˜²æ­¢æ— æ•ˆçš„æ‹–åŠ¨æ“ä½œå¯¼è‡´é”™è¯¯ã€‚
5. **å¤„ç† CSP é”™è¯¯**ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´ CSP æˆ–ç§»é™¤å¤–éƒ¨èµ„æºå¼•ç”¨ã€‚
6. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯æœ€æ–°çš„è„šæœ¬å’Œæ ·å¼ã€‚

å¦‚æœåœ¨å®æ–½ä¸Šè¿°ä¿®å¤åä»é‡åˆ°é—®é¢˜ï¼Œè¯·ç¡®ä¿æ‚¨çš„æ‰€æœ‰æ–‡ä»¶å·²æ­£ç¡®ä¿å­˜ï¼Œå¹¶åœ¨æ§åˆ¶å°ä¸­æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯ã€‚åŒæ—¶ï¼Œå¯ä»¥é€æ­¥è°ƒè¯•ä»£ç ï¼Œä½¿ç”¨ `console.log` æ‰“å°å…³é”®å˜é‡çš„å€¼ï¼Œå¸®åŠ©å®šä½é—®é¢˜ã€‚

å¸Œæœ›è¿™äº›æŒ‡å¯¼èƒ½å¤Ÿå¸®åŠ©æ‚¨è§£å†³é—®é¢˜ï¼Œé¡ºåˆ©å®Œå–„æ‚¨çš„æ‰‘å…‹ç‰Œé¡ºå­æ¸¸æˆï¼
```

```
**è°ƒæ•´å†…å®¹å®‰å…¨æ”¿ç­–**  
æˆ‘æ­£åœ¨è°ƒæ•´ç½‘é¡µæ¸¸æˆçš„å†…å®¹å®‰å…¨æ”¿ç­–ï¼Œç¡®ä¿å¤–éƒ¨å­—ä½“å’Œè„šæœ¬èƒ½å¤Ÿæ­£ç¡®åŠ è½½ã€‚è¿™æ ·å…¬å¹³æ€§å’ŒåŠŸèƒ½æ€§å¾—åˆ°äº†æå‡ã€‚

**è°ƒè¯•JavaScriptä»£ç **

å®šä½å¹¶è§£å†³JavaScriptä¸­çš„æœªå®šä¹‰å˜é‡é—®é¢˜ï¼ŒåŒ…æ‹¬`card`å’Œ`countSameSuit`ï¼Œä»¥åŠæ— æ•ˆçš„`cardId`é”™è¯¯ã€‚

é¢å¯¹CSPé”™è¯¯ï¼Œä¸»è¦æ˜¯å› ä¸ºå­—ä½“å’Œè„šæœ¬åŠ è½½é—®é¢˜ï¼Œå¹¶ä¸”è¿™äº›èµ„æºæ¥è‡ªå¤–éƒ¨Iæµç‚¹comã€‚é™¤éCSPæ˜ç¡®å…è®¸ï¼Œå¦åˆ™æ— æ³•ä»å¤–éƒ¨åŠ è½½å­—ä½“å’Œè„šæœ¬ã€‚è¿™å¯èƒ½æ˜¯ç”±äºæµè§ˆå™¨æ‰©å±•ç¨‹åºå¼•èµ·çš„ã€‚

**è§£å†³è„šæœ¬é—®é¢˜**

ç”¨æˆ·æåˆ°â€œzotero.jsâ€ï¼Œè¿™æ˜¯ä¸€ç§æµè§ˆå™¨æ‰©å±•ï¼Œå¯èƒ½ä¼šæ³¨å…¥è„šæœ¬ï¼Œå¯¼è‡´CSPé”™è¯¯ã€‚å¯ä»¥å¿½ç•¥è¿™äº›é”™è¯¯ï¼Œé™¤éä»£ç å°è¯•åŠ è½½å¤–éƒ¨è„šæœ¬æˆ–å­—ä½“ã€‚ä¸»è¦é—®é¢˜åœ¨JavaScriptä»£ç ä¸­ã€‚

**è§£å†³é—®é¢˜**

ç”¨æˆ·çœ‹åˆ° "Uncaught ReferenceError: countSameSuit is not defined" å’Œ 'cardId' é”™è¯¯ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå‡½æ•°æœªæ­£ç¡®åŠ è½½æˆ–è¯¯å°†éå¡ç‰‡å…ƒç´ è§£æä¸ºå¡ç‰‡ã€‚è€ƒè™‘æ’æŸ¥å¹¶è§£å†³è¿™äº›æ½œåœ¨é—®é¢˜ã€‚

**æ¢è®¨è°ƒåº¦å¡ç‰‡**

ç ”ç©¶HandleDropå‡½æ•°æ—¶ï¼Œæ³¨æ„åˆ°ç”¨æˆ·å°†éå¡ç‰‡å…ƒç´ æ”¾ç½®äºBæ¡†ä¸­å¯èƒ½å¯¼è‡´å¤„ç†é”™è¯¯ã€‚è¿™éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥ã€‚

**è°ƒæŸ¥æ‹–åŠ¨äº‹ä»¶**

æ£€æŸ¥æ˜¯å¦å­å…ƒç´ å½±å“æ•°æ®ä¼ è¾“ï¼Œå»ºè®®åªå…è®¸æ‹–åŠ¨å¡ç‰‡ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“åªåŒ…å«å¡ç‰‡IDã€‚

**çº æ­£é—®é¢˜**

åœ¨ä»£ç ä¸­ï¼Œåˆ›å»ºå¡ç‰‡å…ƒç´ æ—¶ï¼ŒcardDivè®¾ç½®ä¸ºå¯æ‹–åŠ¨ï¼Œå¹¶åœ¨æ‹–åŠ¨å¼€å§‹æ—¶å°†dataTransferè®¾ç½®ä¸ºcard.idã€‚ç„¶è€Œï¼ŒæŸäº›å…ƒç´ å¦‚'card-slot' divså¯èƒ½è¢«é”™è¯¯åœ°è¯†åˆ«ä¸ºå¯æ‹–åŠ¨æˆ–ç›®æ ‡ã€‚CSSæˆ–HTMLç»“æ„å¯èƒ½å¯¼è‡´dropç›®æ ‡å…·æœ‰æ–‡æœ¬å†…å®¹ã€‚

**æŸ¥çœ‹é¡µé¢**

æˆ‘æ­£åœ¨æ£€æŸ¥æ‰‘å…‹ç‰Œé¡ºå­æ¸¸æˆçš„ HTML æ–‡ä»¶ï¼Œå‘ç° A æ¡†å’Œ B æ¡†ï¼Œä»¥åŠå¡æ§½ã€è®¡åˆ†ã€æ‹–åŠ¨æ¬¡æ•°å’Œæ—¶é—´æ˜¾ç¤ºï¼Œå’ŒéŸ³æ•ˆæ–‡ä»¶ç­‰ã€‚

**ç¡®è®¤äº‹ä»¶è§¦å‘æ¡ä»¶**

æˆ‘æ­£åœ¨æ£€æŸ¥'handleDrop'å‡½æ•°ä»¥ç¡®å®š'card-slot' divsä¸­çš„dropäº‹ä»¶æ˜¯å¦ä¼šå½±å“åˆ°æ¡ä»¶åˆ¤æ–­ã€‚æ­¤å¤–ï¼Œ'Invalid cardId'è¡¨æ˜å¯èƒ½æ˜¯å…¶ä»–å…ƒç´ çš„innerTextè¢«è¯¯è§£ä¸ºcardIdã€‚

**åˆ†æé—®é¢˜æ ¹æº**

æ­£åœ¨æ¢è®¨æ•°æ®ä¼ è¾“ç®¡ç†ä¸­çš„æ½œåœ¨é—®é¢˜ã€‚å…³é”®æ˜¯ç¡®ä¿åªæœ‰å¡ç‰‡å…ƒç´ å…·æœ‰draggable=trueï¼Œå¹¶ä¸”ç›®æ ‡åŒºè¶³å¤Ÿå¤§ä»¥ä¸“é—¨æ¥æ”¶å¡ç‰‡ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢è¯¯å¤„ç†éå¡ç‰‡å…ƒç´ ã€‚

**ä¿®æ­£ä»£ç é”™è¯¯**

å“å‘€ï¼Œè„šæœ¬ä¸­'card'å¼•ç”¨éœ€æ›¿æ¢ä¸º'cardObj'ã€‚è¿˜è¦ç¡®è®¤'countSameSuit'å®šä¹‰å’ŒhandleDropå‚æ•°çš„æœ‰æ•ˆæ€§ã€‚

**æ£€æŸ¥è„šæœ¬æ–‡ä»¶**

æˆ‘æ­£åœ¨æ£€æŸ¥ script.js æ–‡ä»¶ï¼Œç¡®ä¿æ²¡æœ‰é‡å¤å®šä¹‰å¼•èµ·è¯­æ³•é”™è¯¯çš„å‡½æ•°ã€‚ç”¨æˆ·æåˆ°çš„ CSP é”™è¯¯å¯èƒ½æ¥è‡ª Zotero å’Œæ‰©å±•ï¼Œå¿½ç•¥å®ƒä»¬å³å¯ã€‚å¦‚æœä»£ç å¼•ç”¨äº†å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œä½†å¤§æ¦‚ç‡æ˜¯ CSS å’Œè„šæœ¬åªå¼•ç”¨äº†æœ¬åœ°èµ„æºã€‚

**æ’é™¤é‡å¤å®šä¹‰**

çœ‹ç€ä»£ç ä¸­çš„æ–°é—®é¢˜ï¼Œå‘ç°'unflipCard'å‡½æ•°å¤šæ¬¡å®šä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯­æ³•é”™è¯¯ã€‚éœ€è¦ç§»é™¤é‡å¤å®šä¹‰ï¼Œä»¥ç¡®ä¿ä»£ç æ­£å¸¸åŠ è½½ã€‚

**ä»£ç æ”¹å–„ä¸æ›´æ–°**

å‘ç°å¤šä¸ªä»£ç é‡å¤å’Œé”™è¯¯ã€‚å»ºè®®å‡å°‘é‡å¤ï¼Œçº æ­£å‘½åé”™è¯¯ï¼Œç¡®ä¿ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€‚

**ä¿®å¤ä»£ç ç»“æ„**

æˆ‘æ­£åœ¨çœ‹script.jsæ–‡ä»¶ï¼Œç¡®ä¿æ²¡æœ‰é‡å¤å®šä¹‰çš„'unflipCard'å‡½æ•°ã€‚ä¿®æ­£å˜é‡åï¼Œæ·»åŠ ç¼ºå¤±éƒ¨åˆ†ï¼Œå¿½ç•¥CSPé”™è¯¯ã€‚

æŠ±æ­‰æ‚¨é‡åˆ°äº†è¿™äº›é—®é¢˜ã€‚æ ¹æ®æ‚¨æä¾›çš„é”™è¯¯ä¿¡æ¯å’Œä»£ç ï¼Œä¸»è¦å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. **JavaScript ä»£ç ä¸­çš„å˜é‡å¼•ç”¨é”™è¯¯**ï¼š
    
    - åœ¨ `flipCard` å‡½æ•°ä¸­ï¼Œé”™è¯¯åœ°ä½¿ç”¨äº†æœªå®šä¹‰çš„ `card` å˜é‡ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `cardObj`ã€‚
    - åœ¨ `checkStraight` å‡½æ•°ä¸­ï¼Œ`countSameSuit` å‡½æ•°æœªè¢«æ­£ç¡®è¯†åˆ«ï¼Œå¯èƒ½æ˜¯ç”±äºä»£ç ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯æˆ–é‡å¤å®šä¹‰ã€‚
2. **é‡å¤å®šä¹‰çš„å‡½æ•°**ï¼š
    
    - æ‚¨çš„ `script.js` æ–‡ä»¶ä¸­ï¼Œ`unflipCard` å‡½æ•°è¢«å®šä¹‰äº†ä¸¤æ¬¡ã€‚è¿™ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯ï¼Œé˜»æ­¢åç»­ä»£ç çš„æ‰§è¡Œã€‚
3. **æ‹–æ”¾é€»è¾‘ä¸­çš„æ— æ•ˆå¡ç‰‡ ID**ï¼š
    
    - æ‚¨çš„æ‹–æ”¾å¤„ç†é€»è¾‘ä¸­ï¼Œæœ‰æ—¶ä¼šæ¥æ”¶åˆ°æ— æ•ˆçš„ `cardId`ï¼Œä¾‹å¦‚ `"B æ¡†ï¼šæ‹–åŠ¨5å¼ è¿ç»­æ‰‘å…‹ç‰Œåˆ°æ­¤å¤„"`ï¼Œè¿™è¡¨æ˜æ‹–æ”¾äº‹ä»¶å¯èƒ½è¢«é”™è¯¯åœ°è§¦å‘æˆ–æ•°æ®ä¼ é€’å‡ºç°é—®é¢˜ã€‚
4. **Content Security Policy (CSP) é”™è¯¯**ï¼š
    
    - æ‚¨çš„ CSP è®¾ç½®é˜»æ­¢äº†ä» `https://at.alicdn.com` åŠ è½½å­—ä½“å’Œè„šæœ¬èµ„æºã€‚è¿™äº›é”™è¯¯ä¸»è¦æ¥è‡ªæµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚ Zoteroï¼‰ï¼Œé€šå¸¸ä¸ä¼šå½±å“æ‚¨çš„åº”ç”¨ç¨‹åºåŠŸèƒ½ã€‚

ä»¥ä¸‹æ˜¯è¯¦ç»†çš„ä¿®å¤æ­¥éª¤å’Œå®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼Œä»¥ç¡®ä¿æ‚¨çš„æ¸¸æˆèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«é¡ºå­ã€åœæ­¢æ¸¸æˆå¹¶æ›´æ–°å¾—åˆ†ã€‚

---

## 1. **ä¿®å¤ JavaScript ä»£ç ä¸­çš„é”™è¯¯**

### 1.1. **ç§»é™¤é‡å¤å®šä¹‰çš„å‡½æ•°**

åœ¨æ‚¨çš„ `script.js` æ–‡ä»¶ä¸­ï¼Œ`unflipCard` å‡½æ•°è¢«å®šä¹‰äº†ä¸¤æ¬¡ã€‚è¿™ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯ï¼Œé˜»æ­¢åç»­ä»£ç çš„æ‰§è¡Œã€‚è¯·ä¿ç•™å…¶ä¸­ä¸€ä¸ªå®šä¹‰ï¼Œå¹¶ç§»é™¤å¦ä¸€ä¸ªã€‚

**ç§»é™¤é‡å¤çš„ `unflipCard` å‡½æ•°ï¼š**

javascript

å¤åˆ¶ä»£ç 

``// ä¿ç•™å…¶ä¸­ä¸€ä¸ª unflipCard å‡½æ•° function unflipCard(cardDiv) {     const cardImg = cardDiv.querySelector('img');     if (cardImg) {         cardImg.src = 'images/back.jpg'; // æ˜¾ç¤ºèƒŒé¢         cardDiv.setAttribute('data-flipped', 'false');     }     console.log(`Unflipping card: ${cardDiv.getAttribute('data-id')}`); }``

### 1.2. **ä¿®æ­£ `flipCard` å‡½æ•°ä¸­çš„å˜é‡å¼•ç”¨**

ç¡®ä¿åœ¨ `flipCard` å‡½æ•°ä¸­ï¼Œæ‰€æœ‰å¯¹ `card` çš„å¼•ç”¨éƒ½å·²æ›´æ­£ä¸º `cardObj`ã€‚

**ä¿®æ­£åçš„ `flipCard` å‡½æ•°ï¼š**

javascript

å¤åˆ¶ä»£ç 

``// ç¿»è½¬æ‰‘å…‹ç‰Œ function flipCard(cardDiv) {     const cardId = cardDiv.getAttribute('data-id');     const cardObj = getCardObjectById(cardId);      if (!cardObj) {         console.error(`Card with ID ${cardId} not found in deck, aDeck, or target.`);         return;     }      const cardImg = cardDiv.querySelector('img');     if (cardImg) {         console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`);         cardImg.src = cardObj.image; // æ˜¾ç¤ºæ­£é¢         cardDiv.setAttribute('data-flipped', 'true');     }     console.log(`Flipping card: ${cardObj.id} to image ${cardObj.image}`); }``

### 1.3. **ç¡®ä¿ `countSameSuit` å‡½æ•°æ­£ç¡®å®šä¹‰**

åœ¨æ‚¨çš„ä»£ç ä¸­ï¼Œ`countSameSuit` å‡½æ•°å·²ç»å®šä¹‰ï¼Œä½†é”™è¯¯æç¤ºä»ç„¶æ˜¾ç¤ºæœªå®šä¹‰ã€‚è¿™å¯èƒ½æ˜¯ç”±äºå‰é¢çš„è¯­æ³•é”™è¯¯ï¼ˆå¦‚é‡å¤å®šä¹‰å‡½æ•°ï¼‰å¯¼è‡´å‡½æ•°æœªèƒ½æ­£ç¡®åŠ è½½ã€‚

**ç¡®ä¿ `countSameSuit` å‡½æ•°æ­£ç¡®å®šä¹‰ï¼š**

javascript

å¤åˆ¶ä»£ç 

`// è®¡ç®—ç›®æ ‡åŒºåŸŸä¸­åŒèŠ±è‰²çš„æœ€å¤§æ•°é‡ function countSameSuit(cards) {     const suitCounts = {};     cards.forEach(card => {         suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;     });     return Math.max(...Object.values(suitCounts)); }`

### 1.4. **ä¿®æ”¹ `handleDrop` å‡½æ•°ä»¥å¤„ç†æ— æ•ˆçš„ `cardId`**

ç”±äºæ‹–åŠ¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ„å¤–æ‹–åŠ¨éå¡ç‰Œå…ƒç´ ï¼Œå¯¼è‡´ `cardId` ä¸æ­£ç¡®ã€‚éœ€è¦åœ¨ `handleDrop` å‡½æ•°ä¸­æ·»åŠ éªŒè¯ï¼Œç¡®ä¿ `cardId` æ˜¯æœ‰æ•ˆçš„å¡ç‰Œ IDã€‚

**ä¿®æ­£åçš„ `handleDrop` å‡½æ•°ï¼š**

javascript

å¤åˆ¶ä»£ç 

``// å¤„ç†æ”¾ç½®äº‹ä»¶ function handleDrop(e) {     e.preventDefault();     const cardId = e.dataTransfer.getData('text/plain');      // éªŒè¯ cardId æ˜¯å¦ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œä¾‹å¦‚ 'card-spade-A'     const validCardIdPattern = /^card-(spade|heart|clover|diamond)-(A|[2-9]|10|J|Q|K)$/;     if (!validCardIdPattern.test(cardId)) {         console.error(`Invalid cardId: ${cardId}`);         showMessage('æ— æ•ˆçš„å¡ç‰‡è¢«æ‹–åŠ¨ï¼', 'fail');         return;     }      const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);     if (!cardDiv) {         console.error(`No card found with id ${cardId}`);         showMessage('æœªæ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡ï¼', 'fail');         return;     }      const source = cardDiv.parentElement.id;      if (this.id === 'target') {         if (source === 'target') {             // åœ¨ B æ¡†å†…é‡æ–°æ’åˆ—æ‰‘å…‹ç‰Œ             targetElement.appendChild(cardDiv);             // ä¸ä¿®æ”¹ target æ•°ç»„ï¼Œä¹Ÿä¸å¢åŠ  dragCount             checkStraight();             saveGameState();         } else {             // ä» A æ¡†æ‹–åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†             if (target.length >= 5) {                 // B æ¡†å·²æ»¡                 showMessage('B æ¡†å·²æ»¡ï¼', 'fail');                 return;             }             // ç§»åŠ¨æ‰‘å…‹ç‰Œåˆ° B æ¡†             targetElement.appendChild(cardDiv);             const cardObj = getCardObjectById(cardId);             if (cardObj && !target.some(card => card.id === cardId)) {                 target.push(cardObj);                 flipCard(cardDiv); // è‡ªåŠ¨ç¿»è½¬æ‰‘å…‹ç‰Œ                 dragCount++;                 updateDragCount();                 aFrameTooltip.style.display = 'none';                 checkStraight();                 saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€                 // ä» aDeck ä¸­ç§»é™¤å·²è¢«æ‹–å…¥ B æ¡†çš„æ‰‘å…‹ç‰Œ                 aDeck = aDeck.filter(card => card.id !== cardId);             }         }     } else if (this.id === 'deck') {         if (source === 'target') {             // ä» B æ¡†æ‹–å› A æ¡†             deckElement.appendChild(cardDiv);             target = target.filter(card => card.id !== cardId);             const cardObj = getCardObjectById(cardId);             if (cardObj) {                 aDeck.push(cardObj); // å°†æ‰‘å…‹ç‰Œæ·»åŠ å› aDeck                 unflipCard(cardDiv); // è‡ªåŠ¨å›åˆ°èƒŒé¢                 dragCount++;                 updateDragCount();                 if (target.length < 5) {                     aFrameTooltip.style.display = 'block';                 }                 saveGameState(); // ä¿å­˜æ¸¸æˆçŠ¶æ€             }         }     }     console.log(`Dragging card: ${cardId} from ${source} to ${this.id}`);     console.log('Target Deck:', target.map(card => card.id));     console.log('A Deck:', aDeck.map(card => card.id)); }``

### 1.5. **ä¿®æ”¹ `loadGameState` å‡½æ•°ä»¥æ­£ç¡®æ˜¾ç¤ºå¾—åˆ†å’Œè®¡æ—¶å™¨**

åœ¨ `loadGameState` å‡½æ•°ä¸­ï¼Œè°ƒç”¨ `updateScore(0)` ä¼šå°†å¾—åˆ†å¢åŠ  0ï¼Œä½†æ²¡æœ‰ç›´æ¥è®¾ç½®å¾—åˆ†æ˜¾ç¤ºã€‚å»ºè®®ç›´æ¥æ›´æ–°å¾—åˆ†æ˜¾ç¤ºã€‚

**ä¿®æ­£åçš„ `loadGameState` å‡½æ•°ï¼š**

javascript

å¤åˆ¶ä»£ç 

``// åŠ è½½æ¸¸æˆçŠ¶æ€ function loadGameState() {     const savedState = localStorage.getItem('gameState');     if (savedState) {         const gameState = JSON.parse(savedState);         dragCount = gameState.dragCount;         score = gameState.score || 0;         comboCount = gameState.comboCount || 0;         timeLeft = gameState.timeLeft || 60;         updateDragCount();         scoreElement.textContent = `å¾—åˆ†ï¼š${score}`; // ç›´æ¥æ›´æ–°æ˜¾ç¤º         timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;          // æ¢å¤ç›®æ ‡åŒºåŸŸ         gameState.target.forEach(cardId => {             const cardDiv = document.querySelector(`.card[data-id='${cardId}']`);             if (cardDiv) {                 targetElement.appendChild(cardDiv);                 const cardObj = getCardObjectById(cardId);                 if (cardObj) {                     target.push(cardObj);                     flipCard(cardDiv);                 }             }         });          // æ¢å¤è®¡æ—¶å™¨         clearInterval(timer);         timer = setInterval(() => {             timeLeft--;             timerElement.textContent = `æ—¶é—´ï¼š${timeLeft}ç§’`;             if (timeLeft <= 0) {                 clearInterval(timer);                 showMessage('æ—¶é—´åˆ°ï¼æ¸¸æˆå¤±è´¥ã€‚', 'fail');                 endgameModal.classList.remove('hidden');                 finalCountElement.textContent = `ä½ çš„æ‹–åŠ¨æ¬¡æ•°æ˜¯ ${dragCount} æ¬¡ï¼Œæ€»å¾—åˆ†æ˜¯ ${score} åˆ†ï¼`;             }         }, 1000);     } }``

---

## 2. **å¤„ç† Content Security Policy (CSP) é”™è¯¯**

### 2.1. **äº†è§£ CSP é”™è¯¯æ¥æº**

ä»æ‚¨çš„é”™è¯¯æ—¥å¿—æ¥çœ‹ï¼Œå¤§éƒ¨åˆ† CSP é”™è¯¯æ˜¯ç”±äºå°è¯•ä» `https://at.alicdn.com` åŠ è½½å­—ä½“å’Œè„šæœ¬èµ„æºã€‚è¿™äº›é”™è¯¯é€šå¸¸æ¥è‡ªæµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚ Zoteroï¼‰æ³¨å…¥çš„èµ„æºï¼Œä¸ä¼šå½±å“æ‚¨çš„åº”ç”¨ç¨‹åºåŠŸèƒ½ã€‚

### 2.2. **å¦‚æœ CSP é”™è¯¯æ¥è‡ªæµè§ˆå™¨æ‰©å±•**

è¿™äº›é”™è¯¯å¯ä»¥å¿½ç•¥ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šå½±å“æ‚¨çš„åº”ç”¨ç¨‹åºã€‚ä½†ä¸ºäº†é¿å…å¹²æ‰°ï¼Œè¯·ç¡®ä¿æ‚¨çš„ä»£ç æ²¡æœ‰ä¾èµ–è¿™äº›å¤–éƒ¨èµ„æºã€‚

### 2.3. **å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬**

å¦‚æœæ‚¨çš„é¡¹ç›®ç¡®å®éœ€è¦åŠ è½½å¤–éƒ¨å­—ä½“æˆ–è„šæœ¬ï¼Œåˆ™éœ€è¦è°ƒæ•´ CSPã€‚åœ¨æ‚¨çš„ `index.html` ä¸­çš„ `<meta http-equiv="Content-Security-Policy">` æ ‡ç­¾ï¼Œæ·»åŠ å¿…è¦çš„æºã€‚

**ç¤ºä¾‹ CSP ä¿®æ”¹ï¼š**

html

å¤åˆ¶ä»£ç 

`<meta http-equiv="Content-Security-Policy" content="     default-src 'self';      script-src 'self' 'unsafe-inline' https://at.alicdn.com;      style-src 'self' 'unsafe-inline' https://at.alicdn.com;      font-src 'self' https://at.alicdn.com; ">`

**è§£é‡Šï¼š**

- `script-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„è„šæœ¬ã€‚
- `style-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„æ ·å¼ã€‚
- `font-src`ï¼šå…è®¸æ¥è‡ª `https://at.alicdn.com` çš„å­—ä½“ã€‚

**æ³¨æ„**ï¼šä»…åœ¨ç¡®å®éœ€è¦æ—¶æ·»åŠ å¤–éƒ¨æºï¼Œå¹¶ç¡®ä¿åªå…è®¸å¯ä¿¡çš„æ¥æºï¼Œä»¥ä¿æŒå®‰å…¨æ€§ã€‚

### 2.4. **ç§»é™¤ä¸å¿…è¦çš„å¤–éƒ¨èµ„æºå¼•ç”¨**

å¦‚æœæ‚¨çš„é¡¹ç›®ä¸éœ€è¦ä» `https://at.alicdn.com` åŠ è½½å­—ä½“æˆ–è„šæœ¬ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ `styles.css` å’Œå…¶ä»–æ–‡ä»¶ï¼Œç§»é™¤ä»»ä½•å¯¹è¿™äº›å¤–éƒ¨èµ„æºçš„å¼•ç”¨ã€‚

---

## 3. **å®Œæ•´ä¿®æ­£åçš„ `script.js`**

ä»¥ä¸‹æ˜¯ä¿®æ­£åçš„å®Œæ•´ `script.js`ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¿…è¦çš„æ›´æ”¹å’Œæ·»åŠ ï¼š

javascript

å¤åˆ¶ä»£ç 

``// script.js  // è·å–DOMå…ƒç´  const deckElement = document.getElementById('deck'); const targetElement = document.getElementById('target'); const dragCountElement = document.getElementById('drag-count'); const resetButton = document.getElementById('reset-button'); const endgameModal = document.getElementById('endgame-modal'); const finalCountElement = document.getElementById('final-count'); const messageBox = document.getElementById('message-box'); const replayButton = document.getElementById('replay-button'); const soundToggle = document.getElementById('sound-toggle'); const successSound = document.getElementById('success-sound'); const failSound = document.getElementById('fail-sound'); const aFrameTooltip = document.getElementById('a-frame-tooltip'); const scoreElement = document.getElementById('score'); const timerElement = document.getElementById('timer');  // æ¸¸æˆçŠ¶æ€ let deck = []; let aDeck = []; let target = []; let dragCount = 0; let score = 0; let comboCount = 0; let isSoundOn = true; let timer; let timeLeft = 60;  // æ‰‘å…‹ç‰Œæ•°æ® const suits = ['spade', 'heart', 'clover', 'diamond']; const numbers = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];  function initGame() {     // é‡ç½®çŠ¶æ€     deck = [];     aDeck = [];     target = [];     dragCount = 0;     score = 0;     comboCount = 0;     updateDragCount();     updateScore(0);     deckElement.innerHTML = '';     targetElement.innerHTML = '';     aFrameTooltip.style.display = 'block';     messageBox.classList.add('hidden', 'success', 'fail', 'info');     endgameModal.classList.add('hidden');      // ç”Ÿæˆä¸€å‰¯å®Œæ•´çš„æ‰‘å…‹ç‰Œï¼ˆåŒ…å«æ‰€æœ‰èŠ±è‰²ï¼‰     for (let suit of suits) {         for (let number of numbers) {             deck.push({                 id: `card-${suit}-${number}`,                 number: number,                 suit: suit,                 image: `images/${suit}_${number}.jpg` // ä½¿ç”¨ç›¸å¯¹è·¯å¾„             });         }     }      // æ‰“ä¹±é¡ºåº     deck = shuffleArray(deck);      // ç¡®ä¿åŒ…å«ä¸€ä¸ªé¡ºå­ç»„åˆ     const possibleSequences = [         [1, 2, 3, 4, 5],         [2, 3, 4, 5, 6],         [3, 4, 5, 6, 7],         [4, 5, 6, 7, 8],         [5, 6, 7, 8, 9],         [6, 7, 8, 9, 10],         [7, 8, 9, 10, 11],         [8, 9, 10, 11, 12],         [9, 10, 11, 12, 13],         [10, 11, 12, 13, 1] // Ace as 14     ];      // éšæœºé€‰æ‹©ä¸€ä¸ªé¡ºå­ç»„åˆ     const chosenSequence = possibleSequences[Math.floor(Math.random() * possibleSequences.length)];      // å°†é¡ºå­åŠ å…¥ A æ¡†ï¼Œä½¿ç”¨ä¸åŒçš„èŠ±è‰²     chosenSequence.forEach((num, index) => {         const suit = suits[index % suits.length];         const foundCard = deck.find(card => card.number == num && card.suit === suit);         if (foundCard) {             aDeck.push(foundCard);         } else {             console.error(`æ— æ³•æ‰¾åˆ°æ•°å­— ${num} å’ŒèŠ±è‰² ${suit} çš„æ‰‘å…‹ç‰Œã€‚`);         }     });      // ä»å‰©ä½™ç‰Œä¸­éšæœºè¡¥è¶³è‡³13å¼      deck = deck.filter(card => !aDeck.includes(card));     while (aDeck.length < 13 && deck.length > 0) {         const randomIndex = Math.floor(Math.random() * deck.length);         const randomCard = deck.splice(randomIndex, 1)[0];         if (randomCard) {             aDeck.push(randomCard);         }     }      // æ‰“ä¹±Aæ¡†çš„é¡ºåº     aDeck = shuffleArray(aDeck);      // æ£€æŸ¥ aDeck æ˜¯å¦æœ‰13å¼ ç‰Œ     if (aDeck.length < 13) {         console.error(`A æ¡†çš„ç‰Œæ•°ä¸è¶³ï¼Œå½“å‰æœ‰ ${aDeck.length} å¼ ç‰Œã€‚`);         // å¯é€‰æ‹©è¡¥å……å…¶ä»–ç‰Œæˆ–é‡æ–°ç”Ÿæˆ aDeck     }      // å°† A æ¡†ä¸­çš„æ‰‘å…‹ç‰Œå…ƒç´ æ·»åŠ åˆ°ç•Œé¢ä¸­     aDeck.forEach(card => {         const cardElement = createCardElement(card);         deckElement.appendChild(cardElement);     });      // é¢„åŠ è½½å›¾ç‰‡     preloadImages();      // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€     clearGameState();      // ä¸åŠ è½½æ¸¸æˆçŠ¶æ€ï¼Œé¿å…é‡ç½®æ—¶åŠ è½½æ—§çš„æ¸¸æˆçŠ¶æ€     // loadGameState(); // æ³¨é‡Šæ‰è¿™è¡Œï¼Œé¿å…å¹²æ‰°åˆå§‹åŒ–      // å¯åŠ¨è®¡æ—¶å™¨     startTimer();      console.log('åˆå§‹åŒ–æ¸¸æˆå®Œæˆã€‚A Deck:', aDeck.map(c => c.id));     console.log('A Deck:', aDeck.map(card => card.id));     console.log('Remaining Deck:', deck.map(card => card.id)); }  // æ›´æ–°å¾—åˆ†æ˜¾ç¤º function updateScore(points) {     score += points;     scoreElement.textContent = `å¾—åˆ†ï¼š${score}`; }  // æ›´æ–°æ‹–åŠ¨æ¬¡æ•°æ˜¾ç¤º function updateDragCount() {     dragCountElement.textContent = `æ‹–åŠ¨æ¬¡æ•°ï¼š${dragCount}`; }  // æ´—ç‰Œç®—æ³•ï¼ˆFisher-Yatesï¼‰ function shuffleArray(array) {     let currentIndex = array.length, randomIndex;      while (currentIndex !== 0) {         randomIndex = Math.floor(Math.random() * currentIndex);         currentIndex--;          // äº¤æ¢         [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];     }      return array; }  // é¢„åŠ è½½å›¾ç‰‡ function preloadImages() {     const imageUrls = deck.map(card => card.image);     imageUrls.push('images/back.jpg');     imageUrls.forEach(url => {         const img = new Image();         img.src = url;     }); }  // åˆ›å»ºæ‰‘å…‹ç‰Œå…ƒç´  function createCardElement(card) {     const cardDiv = document.createElement('div');     cardDiv.classList.add('card');     cardDiv.setAttribute('draggable', true);     cardDiv.setAttribute('data-id', card.id);     cardDiv.setAttribute('data-number', card.number);     cardDiv.setAttribute('data-suit', card.suit);     cardDiv.setAttribute('data-flipped', 'false');      // åˆ›å»ºå›¾ç‰‡å…ƒç´      const cardImg = document.createElement('img');     cardImg.src = 'images/back.jpg'; // åˆå§‹æ˜¾ç¤ºèƒŒé¢     cardImg.alt = `${card.suit} ${card.number}`;     cardImg.classList.add('card-image');      console.log(`Creating card: ${card.id} with image ${cardImg.src}`); // è°ƒè¯•æ—¥å¿—      cardDiv.appendChild(cardImg);      // äº‹ä»¶ç›‘å¬     cardDiv.addEventListener('dragstart', handleDragStart);     // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨     // cardDiv.addEventListener('click', handleCardClick);     cardDiv.addEventListener('dragend', handleDragEnd);      return cardDiv; }  // ç¿»è½¬æ‰‘å…‹ç‰Œ function flipCard(cardDiv) {     const cardId = cardDiv.getAttribute('data-id');     const cardObj = getCardObject``
```